<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ç»å¯†Â·ç«¯å¯¹ç«¯ç›´è¿</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
  :root{--bg:#121212;--card:#1e1e1e;--text:#e0e0e0;--accent:#00ff88;--me:#005c35;--other:#2a2a2a;}
  body{margin:0;font-family:-apple-system,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
  
  /* é¡¶éƒ¨è¿æ¥åŒº */
  #header{padding:15px;background:var(--card);border-bottom:1px solid #333;box-shadow:0 2px 10px rgba(0,0,0,0.5);z-index:10;}
  .status-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  .status-dot{height:10px;width:10px;border-radius:50%;background:#ff4444;display:inline-block;margin-right:5px;box-shadow:0 0 5px #ff4444;}
  .connected .status-dot{background:var(--accent);box-shadow:0 0 8px var(--accent);}
  
  .id-box{background:#000;padding:8px;border-radius:5px;font-family:monospace;font-size:14px;display:flex;justify-content:space-between;align-items:center;border:1px solid #333;}
  .copy-btn{background:var(--accent);color:#000;border:none;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold;cursor:pointer;}
  
  #connect-area{margin-top:10px;display:flex;gap:10px;}
  #target-id{flex:1;background:#000;border:1px solid #333;color:#fff;padding:8px;border-radius:4px;outline:none;}
  #conn-btn{background:#333;color:#fff;border:1px solid #555;padding:0 15px;border-radius:4px;cursor:pointer;}

  /* èŠå¤©åŒºåŸŸ */
  #chat-box{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px;scroll-behavior:smooth;}
  .msg{max-width:80%;padding:10px 14px;border-radius:12px;font-size:15px;line-height:1.4;word-break:break-word;position:relative;}
  .msg.me{align-self:flex-end;background:var(--me);color:#fff;border-bottom-right-radius:2px;}
  .msg.other{align-self:flex-start;background:var(--other);color:#ddd;border-bottom-left-radius:2px;}
  .sys-msg{align-self:center;background:rgba(255,255,255,0.1);padding:4px 12px;border-radius:20px;font-size:12px;color:#888;margin:5px 0;}

  /* åº•éƒ¨è¾“å…¥ */
  #footer{padding:10px;background:var(--card);border-top:1px solid #333;display:flex;gap:10px;}
  #input{flex:1;background:#2a2a2a;border:none;color:#fff;padding:12px;border-radius:20px;outline:none;}
  #send{background:var(--accent);color:#000;border:none;width:45px;height:45px;border-radius:50%;font-weight:bold;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
  
  .hidden{display:none !important;}
</style>
</head>
<body>

<div id="header">
  <div class="status-bar">
    <div><span class="status-dot" id="status-dot"></span><span id="status-text">ç¦»çº¿ (æœªè¿æ¥)</span></div>
    <button onclick="clearChat()" style="background:transparent;border:none;color:#666;font-size:12px;">æ¸…ç©ºè®°å½•</button>
  </div>
  
  <!-- æ˜¾ç¤ºæˆ‘çš„ID -->
  <div class="id-box">
    <span id="my-id">æ­£åœ¨ç”Ÿæˆå¯†é’¥...</span>
    <button class="copy-btn" onclick="copyId()">å¤åˆ¶</button>
  </div>

  <!-- è¿æ¥å¯¹æ–¹ -->
  <div id="connect-area">
    <input type="text" id="target-id" placeholder="è¾“å…¥å¯¹æ–¹çš„ ID">
    <button id="conn-btn" onclick="connectToPeer()">è¿æ¥</button>
  </div>
</div>

<div id="chat-box">
  <div class="sys-msg">ğŸ”’ æ¶ˆæ¯å·²å¯ç”¨ç«¯å¯¹ç«¯åŠ å¯† (P2P)</div>
  <div class="sys-msg">æ•°æ®ä»…å­˜å‚¨åœ¨åŒæ–¹è®¾å¤‡æœ¬åœ°</div>
</div>

<div id="footer">
  <input type="text" id="input" placeholder="å‘é€åŠ å¯†æ¶ˆæ¯..." autocomplete="off">
  <button id="send" onclick="sendMsg()">â¤</button>
</div>

<script>
  // ç”Ÿæˆä¸€ä¸ªçŸ­ä¸€ç‚¹çš„éšæœºIDæ–¹ä¾¿è¾“å…¥
  const myPeerId = 'user_' + Math.floor(Math.random() * 9000 + 1000);
  let conn = null;
  
  // åˆå§‹åŒ– PeerJS (ä½¿ç”¨å…¬å…±å…è´¹æœåŠ¡å™¨æ¡æ‰‹ï¼Œæ•°æ®èµ°P2P)
  const peer = new Peer(myPeerId, {
    debug: 1 // 0=none, 1=errors, 2=warnings
  });

  // DOM å…ƒç´ 
  const dom = {
    myId: document.getElementById('my-id'),
    statusText: document.getElementById('status-text'),
    statusDot: document.getElementById('status-dot'),
    chatBox: document.getElementById('chat-box'),
    input: document.getElementById('input'),
    targetInput: document.getElementById('target-id'),
    connArea: document.getElementById('connect-area')
  };

  // 1. Peer æ‰“å¼€æˆåŠŸ
  peer.on('open', (id) => {
    dom.myId.innerText = id;
    dom.statusText.innerText = "ç­‰å¾…è¿æ¥...";
    loadHistory(); // åŠ è½½æœ¬åœ°å†å²
  });

  // 2. è¢«åŠ¨æ¥æ”¶è¿æ¥ (åˆ«äººè¿æˆ‘)
  peer.on('connection', (connection) => {
    if(conn) { connection.close(); return; } // ç®€å•å¤„ç†ï¼šä¸€å¯¹ä¸€ï¼Œæ‹’ç»ç¬¬ä¸‰è€…
    setupConnection(connection);
    alert("å¯¹æ–¹å·²æ¥å…¥åŠ å¯†é€šé“ï¼");
  });

  // 3. ä¸»åŠ¨å‘èµ·è¿æ¥ (æˆ‘è¿åˆ«äºº)
  function connectToPeer() {
    const targetId = dom.targetInput.value.trim();
    if(!targetId) return alert("è¯·è¾“å…¥å¯¹æ–¹ID");
    if(targetId === myPeerId) return alert("ä¸èƒ½è¿æ¥è‡ªå·±");
    
    const connection = peer.connect(targetId);
    setupConnection(connection);
  }

  // å»ºç«‹è¿æ¥åçš„é€šç”¨å¤„ç†
  function setupConnection(connection) {
    conn = connection;
    
    conn.on('open', () => {
      dom.statusText.innerText = "å·²åŠ å¯†è¿æ¥: " + conn.peer;
      dom.statusText.style.color = "#00ff88";
      dom.statusDot.parentElement.classList.add('connected');
      dom.connArea.classList.add('hidden'); // éšè—è¿æ¥æ¡†
      sysMsg("é€šé“å»ºç«‹æˆåŠŸã€‚åŒæ–¹éƒ½åœ¨çº¿æ—¶å¯å®æ—¶é€šè®¯ã€‚");
    });

    conn.on('data', (data) => {
      // æ”¶åˆ°æ¶ˆæ¯
      appendMsg(data.text, 'other');
      saveMsg(data.text, 'other');
    });

    conn.on('close', () => {
      sysMsg("å¯¹æ–¹å·²æ–­å¼€è¿æ¥");
      resetUI();
    });
    
    conn.on('error', () => {
      sysMsg("è¿æ¥å‘ç”Ÿé”™è¯¯");
      resetUI();
    });
  }

  // å‘é€æ¶ˆæ¯
  function sendMsg() {
    const text = dom.input.value.trim();
    if(!text) return;
    
    if(conn && conn.open) {
      // å‘é€ç»™å¯¹æ–¹
      conn.send({ text: text });
      // æ˜¾ç¤ºç»™è‡ªå·±
      appendMsg(text, 'me');
      saveMsg(text, 'me');
      dom.input.value = '';
    } else {
      alert("å°šæœªè¿æ¥å¯¹æ–¹ï¼Œæˆ–è¿æ¥å·²æ–­å¼€ï¼");
    }
  }

  // UI è¾…åŠ©å‡½æ•°
  function appendMsg(text, type) {
    const div = document.createElement('div');
    div.className = `msg ${type}`;
    div.innerText = text;
    dom.chatBox.appendChild(div);
    dom.chatBox.scrollTop = dom.chatBox.scrollHeight;
  }

  function sysMsg(text) {
    const div = document.createElement('div');
    div.className = 'sys-msg';
    div.innerText = text;
    dom.chatBox.appendChild(div);
  }

  function resetUI() {
    conn = null;
    dom.statusText.innerText = "è¿æ¥ä¸­æ–­";
    dom.statusText.style.color = "#aaa";
    dom.statusDot.parentElement.classList.remove('connected');
    dom.connArea.classList.remove('hidden');
  }

  function copyId() {
    navigator.clipboard.writeText(myPeerId).then(()=>alert("IDå·²å¤åˆ¶ï¼Œå‘ç»™æœ‹å‹è®©ä»–å¡«å…¥å¹¶è¿æ¥"));
  }

  // æœ¬åœ°å­˜å‚¨é€»è¾‘ (LocalStorage)
  function saveMsg(text, type) {
    const history = JSON.parse(localStorage.getItem('p2p_history') || '[]');
    history.push({ text, type, time: Date.now() });
    localStorage.setItem('p2p_history', JSON.stringify(history));
  }

  function loadHistory() {
    const history = JSON.parse(localStorage.getItem('p2p_history') || '[]');
    history.forEach(h => appendMsg(h.text, h.type));
  }

  function clearChat() {
    if(confirm("ç¡®å®šé”€æ¯æœ¬æœºæ‰€æœ‰èŠå¤©è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚")) {
      localStorage.removeItem('p2p_history');
      dom.chatBox.innerHTML = '';
      sysMsg("æœ¬æœºè®°å½•å·²é”€æ¯");
    }
  }

  // ç»‘å®šå›è½¦å‘é€
  dom.input.addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendMsg();
  });
</script>

</body>
</html>
