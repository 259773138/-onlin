<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexChat | é›¶é…ç½®ç»ˆç«¯</title>
    <!-- æ ¸å¿ƒåº“ (å›½å†…ä¼˜é€‰æº) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#10b981', // Emerald 500
                        dark: '#121212',
                        panel: '#1e1e1e',
                        bubble: '#2c2c2c'
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        ::-webkit-scrollbar { width: 0px; background: transparent; } /* éšè—æ»šåŠ¨æ¡ */
        .glass-header { background: rgba(30,30,30,0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="bg-dark text-gray-200 h-screen w-screen overflow-hidden font-sans select-none">

<div id="app" v-cloak class="h-full max-w-lg mx-auto flex flex-col relative bg-dark shadow-2xl md:border-x border-white/5">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="h-16 flex items-center justify-between px-5 glass-header z-30 absolute top-0 w-full">
        <div class="flex items-center gap-3">
            <button v-if="currentView === 'private'" @click="switchView('public')" class="p-2 -ml-2 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            
            <div @click="showMenu = true" class="flex flex-col cursor-pointer">
                <h1 class="text-lg font-bold tracking-wide flex items-center gap-2">
                    {{ title }}
                    <span class="w-2 h-2 rounded-full" :class="isOnline ? 'bg-primary shadow-[0_0_8px_#10b981]' : 'bg-red-500'"></span>
                </h1>
                <span class="text-[10px] text-gray-500 font-mono tracking-wider">ID: {{ myIdShort }}</span>
            </div>
        </div>

        <!-- å³ä¾§èœå•æŒ‰é’® -->
        <button @click="showMenu = true" class="p-2 bg-white/5 rounded-full hover:bg-white/10 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </header>

    <!-- æ¶ˆæ¯åŒºåŸŸ -->
    <main class="flex-1 overflow-y-auto pt-20 pb-4 px-4 space-y-5" id="chat-container">
        <!-- æ¬¢è¿/çŠ¶æ€å¡ç‰‡ -->
        <div class="text-center py-4">
            <span class="px-3 py-1 rounded-full bg-white/5 text-[10px] text-gray-500 border border-white/5">
                {{ currentView === 'public' ? 'ğŸ“¡ å¹¿æ’­æ¨¡å¼ï¼šæ¶ˆæ¯å°†å‘é€ç»™æ‰€æœ‰åœ¨çº¿å¥½å‹' : 'ğŸ”’ ç»å¯†æ¨¡å¼ï¼šç‚¹å¯¹ç‚¹åŠ å¯†ç›´è¿' }}
            </span>
        </div>

        <!-- æ¶ˆæ¯æ°”æ³¡ -->
        <div v-for="(msg, i) in currentMessages" :key="i" class="flex flex-col" :class="msg.isMe ? 'items-end' : 'items-start'">
            <div class="flex items-center gap-2 mb-1 px-1">
                <span v-if="!msg.isMe" class="text-[11px] font-bold text-gray-400">{{ msg.senderName }}</span>
                <span class="text-[9px] text-gray-600 font-mono">{{ msg.time }}</span>
            </div>
            
            <div class="max-w-[85%] px-4 py-2.5 rounded-2xl text-[15px] leading-relaxed break-words shadow-sm relative group"
                 :class="msg.isMe ? 'bg-primary text-black font-medium rounded-tr-sm' : 'bg-bubble text-gray-200 rounded-tl-sm'">
                {{ msg.text }}
            </div>
        </div>
        
        <!-- åº•éƒ¨å«é«˜ -->
        <div class="h-16"></div>
    </main>

    <!-- åº•éƒ¨è¾“å…¥æ¡† -->
    <footer class="absolute bottom-0 w-full p-4 glass-header z-30">
        <div class="flex items-center gap-3 bg-panel p-1.5 rounded-full border border-white/10 focus-within:border-primary/50 transition-colors">
            <input v-model="inputText" @keyup.enter="send" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 bg-transparent px-4 py-2 outline-none text-white placeholder-gray-600">
            <button @click="send" :disabled="!inputText.trim()" class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-black hover:bg-emerald-400 disabled:opacity-50 disabled:cursor-not-allowed transition">
                <svg class="w-5 h-5 translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </div>
    </footer>

    <!-- å³ä¾§æ»‘èœå• -->
    <transition name="slide">
        <div v-if="showMenu" class="absolute inset-0 z-50 bg-dark flex flex-col">
            <!-- èœå•å¤´ -->
            <div class="h-20 px-6 flex items-end justify-between pb-4 bg-panel border-b border-white/5">
                <h2 class="text-2xl font-bold text-white">æ§åˆ¶å°</h2>
                <button @click="showMenu = false" class="p-2 bg-white/10 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <!-- ä¸ªäººä¿¡æ¯ -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">æˆ‘çš„èº«ä»½</h3>
                    <div class="bg-panel p-4 rounded-xl border border-white/5 space-y-3">
                        <input v-model="myName" @change="saveSettings" class="w-full bg-transparent text-xl font-bold text-primary border-b border-white/10 focus:border-primary outline-none py-1" placeholder="è®¾å®šæ˜µç§°">
                        <div @click="copyId" class="flex items-center justify-between bg-black/30 p-3 rounded-lg cursor-pointer active:scale-95 transition">
                            <div>
                                <div class="text-[10px] text-gray-500 mb-1">é€šè®¯ ID (ç‚¹å‡»å¤åˆ¶)</div>
                                <div class="font-mono text-xs text-gray-300">{{ myId }}</div>
                            </div>
                            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 012 2v8a2 2 0 01-2 2h-8a2 2 0 01-2-2v-8a2 2 0 012-2h8"></path></svg>
                        </div>
                    </div>
                </div>

                <!-- å¥½å‹ç®¡ç† -->
                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">å¥½å‹åˆ—è¡¨</h3>
                        <button @click="showAddModal = true" class="text-xs text-primary font-bold hover:underline">+ æ·»åŠ å¥½å‹</button>
                    </div>
                    
                    <div v-if="friends.length === 0" class="text-center py-6 text-gray-600 text-sm bg-panel rounded-xl border border-white/5 border-dashed">
                        æš‚æ— å¥½å‹ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ <br>å»ºç«‹è¿æ¥åå³å¯ç§èŠ
                    </div>

                    <div class="space-y-2">
                        <!-- å¹¿æ’­é¢‘é“å…¥å£ -->
                        <div @click="enterChat('public')" :class="['p-4 rounded-xl flex items-center gap-3 cursor-pointer border transition', currentView === 'public' ? 'bg-primary/10 border-primary' : 'bg-panel border-white/5']">
                            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-lg">ğŸ“¡</div>
                            <div>
                                <div class="font-bold text-sm">å¹¿æ’­é¢‘é“</div>
                                <div class="text-[10px] text-gray-500">å‘é€ç»™æ‰€æœ‰åœ¨çº¿å¥½å‹</div>
                            </div>
                        </div>

                        <!-- å¥½å‹åˆ—è¡¨ -->
                        <div v-for="friend in friends" :key="friend.id" @click="enterChat(friend)" class="p-3 bg-panel rounded-xl border border-white/5 flex items-center justify-between active:scale-95 transition cursor-pointer">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-black flex items-center justify-center font-bold text-white relative border border-white/10">
                                    {{ friend.name.slice(0,1) }}
                                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-panel" :class="connections[friend.id] ? 'bg-primary' : 'bg-red-500'"></div>
                                </div>
                                <div>
                                    <div class="font-bold text-sm text-gray-200">{{ friend.name }}</div>
                                    <div class="text-[10px]" :class="connections[friend.id] ? 'text-primary' : 'text-gray-500'">{{ connections[friend.id] ? 'åœ¨çº¿' : 'ç¦»çº¿' }}</div>
                                </div>
                            </div>
                            <button @click.stop="deleteFriend(friend.id)" class="p-2 text-gray-600 hover:text-red-500">âœ•</button>
                        </div>
                    </div>
                </div>
                
                <!-- æ¸…ç†æ•°æ® -->
                <button @click="clearData" class="w-full py-3 rounded-xl border border-red-900/50 text-red-500 text-sm hover:bg-red-900/10 transition">é”€æ¯æ‰€æœ‰æœ¬åœ°æ•°æ®</button>
            </div>
        </div>
    </transition>

    <!-- æ·»åŠ å¥½å‹å¼¹çª— -->
    <div v-if="showAddModal" class="absolute inset-0 z-[60] bg-black/90 flex items-center justify-center p-8 backdrop-blur-sm">
        <div class="bg-panel w-full max-w-sm p-6 rounded-2xl border border-white/10 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">å»ºç«‹è¿æ¥</h3>
            <input v-model="newFriendId" placeholder="è¾“å…¥å¯¹æ–¹ ID" class="w-full bg-dark text-white p-3 rounded-lg border border-white/10 mb-3 outline-none focus:border-primary">
            <input v-model="newFriendName" placeholder="ç»™TAå¤‡æ³¨" class="w-full bg-dark text-white p-3 rounded-lg border border-white/10 mb-6 outline-none focus:border-primary">
            <div class="flex gap-3">
                <button @click="showAddModal = false" class="flex-1 py-3 bg-white/5 rounded-lg hover:bg-white/10 transition">å–æ¶ˆ</button>
                <button @click="addFriend" class="flex-1 py-3 bg-primary text-black font-bold rounded-lg hover:bg-emerald-400 transition">è¿æ¥</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- æ ¸å¿ƒæ•°æ® ---
            const myId = ref('æ­£åœ¨åˆå§‹åŒ–...');
            const myName = ref(localStorage.getItem('nc_name') || 'åŒ¿å' + Math.floor(Math.random()*999));
            const friends = ref(JSON.parse(localStorage.getItem('nc_friends') || '[]'));
            // å­˜å‚¨ç»“æ„ï¼š { 'public': [], 'friendId1': [], ... }
            const history = reactive(JSON.parse(localStorage.getItem('nc_history') || '{"public":[]}'));
            
            // --- UI çŠ¶æ€ ---
            const currentView = ref('public'); // 'public' | 'private'
            const activeFriendId = ref(null);
            const showMenu = ref(false);
            const showAddModal = ref(false);
            const inputText = ref('');
            const isOnline = ref(false);
            
            // --- PeerJS ---
            const connections = reactive({});
            let peer = null;
            
            // è¡¨å•
            const newFriendId = ref('');
            const newFriendName = ref('');

            onMounted(() => {
                initPeer();
                // è‡ªåŠ¨è¿æ¥æ‰€æœ‰å¥½å‹
                setInterval(retryConnections, 5000);
            });

            // --- é€»è¾‘éƒ¨åˆ† ---
            
            const initPeer = () => {
                let savedId = localStorage.getItem('nc_uid');
                if(!savedId) {
                    savedId = 'u' + Math.random().toString(36).substr(2, 8);
                    localStorage.setItem('nc_uid', savedId);
                }
                
                peer = new Peer(savedId, { debug: 1 });

                peer.on('open', (id) => {
                    myId.value = id;
                    isOnline.value = true;
                    retryConnections();
                });

                peer.on('connection', (conn) => {
                    handleConn(conn);
                });

                peer.on('disconnected', () => isOnline.value = false);
                peer.on('error', (err) => console.log(err));
            };

            const handleConn = (conn) => {
                conn.on('open', () => {
                    connections[conn.peer] = conn;
                });
                conn.on('data', (data) => {
                    // data: { type: 'chat', text: '...', fromName: '...' }
                    // åªæœ‰å¥½å‹åˆ—è¡¨é‡Œçš„äººå‘æ¶ˆæ¯æ‰æ¥æ”¶ï¼Œæˆ–è€…è‡ªåŠ¨æ¥æ”¶å¹¶æç¤ºï¼Ÿ
                    // è¿™é‡Œç®€åŒ–ä¸ºï¼šæ”¶åˆ°å³å­˜å‚¨
                    receiveMessage(conn.peer, data);
                });
                conn.on('close', () => delete connections[conn.peer]);
                connections[conn.peer] = conn;
            };

            const retryConnections = () => {
                if(!peer || peer.disconnected) return;
                friends.value.forEach(f => {
                    if(!connections[f.id] || !connections[f.id].open) {
                        const conn = peer.connect(f.id);
                        handleConn(conn);
                    }
                });
            };

            const send = () => {
                const text = inputText.value.trim();
                if(!text) return;

                const msgObj = {
                    text,
                    senderName: myName.value,
                    time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                    isMe: true
                };

                if(currentView.value === 'public') {
                    // å¹¿æ’­æ¨¡å¼ï¼šå­˜å…¥ publicï¼Œå¹¶å‘é€ç»™æ‰€æœ‰è¿æ¥
                    saveMsg('public', msgObj);
                    Object.values(connections).forEach(conn => {
                        if(conn.open) conn.send({ type: 'public', text, fromName: myName.value });
                    });
                } else {
                    // ç§èŠæ¨¡å¼
                    const conn = connections[activeFriendId.value];
                    if(conn && conn.open) {
                        conn.send({ type: 'private', text, fromName: myName.value });
                        saveMsg(activeFriendId.value, msgObj);
                    } else {
                        alert("å¯¹æ–¹ä¸åœ¨çº¿ï¼Œæ— æ³•å‘é€");
                        return; // å¤±è´¥ä¸å­˜
                    }
                }
                inputText.value = '';
                scrollToBottom();
            };

            const receiveMessage = (peerId, data) => {
                const msgObj = {
                    text: data.text,
                    senderName: data.fromName || 'å¯¹æ–¹',
                    time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                    isMe: false
                };

                // åˆ¤æ–­æ˜¯å¹¿æ’­æ¶ˆæ¯è¿˜æ˜¯ç§èŠ
                const targetBox = data.type === 'public' ? 'public' : peerId;
                
                // å¦‚æœæ˜¯é™Œç”Ÿäººå‘ç§èŠï¼Œè‡ªåŠ¨æ·»åŠ ä¸ºâ€œä¸´æ—¶è”ç³»äººâ€é€»è¾‘å¯åœ¨æ­¤æ‰©å±•
                // è¿™é‡Œç®€å•å¤„ç†ï¼šå¦‚æœä¸åœ¨å¥½å‹åˆ—è¡¨ï¼Œè§†ä¸ºå¹¿æ’­æˆ–è€…å¿½ç•¥ï¼Œä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬å­˜å…¥ public æˆ–è€…å¯¹åº”ID
                
                saveMsg(targetBox, msgObj);
            };

            const saveMsg = (key, msg) => {
                if(!history[key]) history[key] = [];
                history[key].push(msg);
                // é™åˆ¶å­˜å‚¨æ•°é‡é˜²æ­¢ LocalStorage çˆ†ç‚¸
                if(history[key].length > 100) history[key].shift();
                localStorage.setItem('nc_history', JSON.stringify(history));
                
                if(currentView.value === 'public' && key === 'public') scrollToBottom();
                if(currentView.value === 'private' && key === activeFriendId.value) scrollToBottom();
            };

            // --- ç•Œé¢äº¤äº’ ---

            const enterChat = (target) => {
                if(target === 'public') {
                    currentView.value = 'public';
                    activeFriendId.value = null;
                } else {
                    currentView.value = 'private';
                    activeFriendId.value = target.id;
                }
                showMenu.value = false;
                scrollToBottom();
            };

            const switchView = (v) => {
                currentView.value = v;
                if(v === 'public') activeFriendId.value = null;
            };

            const addFriend = () => {
                if(!newFriendId.value) return;
                const exists = friends.value.find(f => f.id === newFriendId.value);
                if(!exists) {
                    friends.value.push({ id: newFriendId.value, name: newFriendName.value || 'å¥½å‹' });
                    localStorage.setItem('nc_friends', JSON.stringify(friends.value));
                    retryConnections();
                }
                showAddModal.value = false;
                newFriendId.value = ''; newFriendName.value = '';
            };

            const deleteFriend = (id) => {
                if(confirm("åˆ é™¤å¥½å‹ï¼Ÿå†å²è®°å½•å°†ä¿ç•™ã€‚")) {
                    friends.value = friends.value.filter(f => f.id !== id);
                    localStorage.setItem('nc_friends', JSON.stringify(friends.value));
                }
            };

            const saveSettings = () => {
                localStorage.setItem('nc_name', myName.value);
            };

            const copyId = () => {
                navigator.clipboard.writeText(myId.value);
                alert("IDå·²å¤åˆ¶");
            };

            const clearData = () => {
                if(confirm("è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æœ¬æœºæ‰€æœ‰èŠå¤©è®°å½•å’Œå¥½å‹åˆ—è¡¨ï¼")) {
                    localStorage.clear();
                    location.reload();
                }
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    const el = document.getElementById('chat-container');
                    if(el) el.scrollTop = el.scrollHeight;
                });
            };

            // æ ‡é¢˜
            const title = computed(() => {
                if(currentView.value === 'public') return 'å¹¿æ’­é¢‘é“';
                const f = friends.value.find(f => f.id === activeFriendId.value);
                return f ? f.name : 'ç§èŠ';
            });
            
            const currentMessages = computed(() => {
                if(currentView.value === 'public') return history['public'] || [];
                return history[activeFriendId.value] || [];
            });
            
            const myIdShort = computed(() => myId.value.length > 8 ? myId.value.substring(0,6)+'...' : myId.value);

            return {
                myId, myIdShort, myName, isOnline, currentView, showMenu, showAddModal,
                friends, connections, inputText, newFriendId, newFriendName,
                title, currentMessages,
                send, enterChat, switchView, addFriend, deleteFriend, saveSettings, copyId, clearData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
