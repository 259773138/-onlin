<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <title>NexChat | æ²‰æµ¸ç»ˆç«¯</title>
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#10b981', 
                        dark: '#121212',
                        panel: '#1e1e1e',
                        bubble: '#2c2c2c'
                    }
                }
            }
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        /* å…³é”®ï¼šä½¿ç”¨ dvh è§£å†³æ‰‹æœºåœ°å€æ é®æŒ¡é—®é¢˜ */
        .h-dynamic-screen { height: 100vh; height: 100dvh; }
        
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .glass-header { background: rgba(30,30,30,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        /* å¯åŠ¨åŠ¨ç”» */
        .pulse-ring { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.9); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
    </style>
</head>
<body class="bg-dark text-gray-200 overflow-hidden font-sans select-none">

<div id="app" v-cloak class="w-full h-dynamic-screen flex flex-col relative bg-dark">

    <!-- å¯åŠ¨ç½‘å…³ (ç‚¹å‡»è¿›å…¥å…¨å±) -->
    <transition name="fade">
        <div v-if="!isStarted" class="absolute inset-0 z-[100] bg-dark flex flex-col items-center justify-center p-6 text-center">
            <div class="relative w-24 h-24 mb-8 flex items-center justify-center">
                <div class="absolute inset-0 border-2 border-primary rounded-full pulse-ring"></div>
                <button @click="enterSystem" class="w-20 h-20 bg-primary rounded-full flex items-center justify-center shadow-[0_0_20px_#10b981] active:scale-90 transition transform">
                    <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </button>
            </div>
            <h1 class="text-2xl font-bold text-white mb-2 tracking-widest">NEXCHAT</h1>
            <p class="text-xs text-gray-500 mb-8">P2P åŠ å¯†ç›´è¿åè®® / æœ¬åœ°å­˜å‚¨</p>
            <div class="text-[10px] text-gray-600 animate-pulse">ç‚¹å‡»æŒ‰é’®å¯åŠ¨å…¨å±æ²‰æµ¸æ¨¡å¼</div>
        </div>
    </transition>

    <!-- ä¸»ç•Œé¢ -->
    <div v-if="isStarted" class="flex-1 flex flex-col h-full max-w-lg mx-auto md:border-x border-white/5 relative shadow-2xl">
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="h-14 flex-none flex items-center justify-between px-4 glass-header z-30">
            <div class="flex items-center gap-3">
                <button v-if="currentView === 'private'" @click="switchView('public')" class="p-1 -ml-1 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                
                <div @click="showMenu = true" class="flex flex-col cursor-pointer">
                    <h1 class="text-base font-bold tracking-wide flex items-center gap-2 text-white">
                        {{ title }}
                        <span class="w-1.5 h-1.5 rounded-full" :class="isOnline ? 'bg-primary shadow-[0_0_8px_#10b981]' : 'bg-red-500'"></span>
                    </h1>
                </div>
            </div>
            <button @click="showMenu = true" class="p-2 bg-white/5 rounded-full hover:bg-white/10 transition">
                <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </header>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <main class="flex-1 overflow-y-auto px-4 py-4 space-y-4 scroll-smooth" id="chat-container">
            <div class="text-center py-2 opacity-50">
                <span class="text-[10px] text-gray-500 tracking-wider">
                    {{ currentView === 'public' ? '--- å¹¿æ’­é¢‘æ®µ ---' : '--- åŠ å¯†ç›´è¿ ---' }}
                </span>
            </div>

            <div v-for="(msg, i) in currentMessages" :key="i" class="flex flex-col" :class="msg.isMe ? 'items-end' : 'items-start'">
                <div class="flex items-center gap-2 mb-1 px-1">
                    <span v-if="!msg.isMe" class="text-[10px] font-bold text-gray-400">{{ msg.senderName }}</span>
                    <span class="text-[9px] text-gray-600 font-mono">{{ msg.time }}</span>
                </div>
                <div class="max-w-[85%] px-4 py-2 rounded-2xl text-[15px] leading-snug break-words shadow-md"
                     :class="msg.isMe ? 'bg-primary text-black font-medium rounded-tr-sm' : 'bg-bubble text-gray-200 rounded-tl-sm'">
                    {{ msg.text }}
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨è¾“å…¥æ¡† (é€‚é…å®‰å…¨åŒºåŸŸ) -->
        <footer class="flex-none p-3 glass-header z-30 pb-[max(12px,env(safe-area-inset-bottom))]">
            <div class="flex items-center gap-2 bg-panel p-1 rounded-full border border-white/10 focus-within:border-primary/50 transition-colors">
                <input v-model="inputText" @keyup.enter="send" type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 bg-transparent px-4 py-2 outline-none text-white placeholder-gray-600 text-sm">
                <button @click="send" :disabled="!inputText.trim()" class="w-9 h-9 rounded-full bg-primary flex items-center justify-center text-black hover:bg-emerald-400 disabled:opacity-50 transition">
                    <svg class="w-4 h-4 translate-x-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>
        </footer>

        <!-- å³ä¾§æ»‘èœå• -->
        <transition name="slide">
            <div v-if="showMenu" class="absolute inset-0 z-50 bg-dark flex flex-col h-full">
                <div class="h-16 px-5 flex items-center justify-between bg-panel border-b border-white/5 flex-none">
                    <h2 class="text-lg font-bold text-white">æ§åˆ¶å°</h2>
                    <button @click="showMenu = false" class="p-2 bg-white/10 rounded-full text-gray-300">âœ•</button>
                </div>

                <div class="flex-1 overflow-y-auto p-5 space-y-6">
                    <div class="bg-panel p-4 rounded-xl border border-white/5 space-y-3">
                        <label class="text-xs text-gray-500 uppercase">æˆ‘çš„èº«ä»½</label>
                        <input v-model="myName" @change="saveSettings" class="w-full bg-transparent text-lg font-bold text-primary border-b border-white/10 focus:border-primary outline-none py-1">
                        <div @click="copyId" class="flex items-center justify-between bg-black/30 p-3 rounded-lg cursor-pointer active:bg-white/5">
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-[10px] text-gray-500">é€šè®¯ ID (ç‚¹å‡»å¤åˆ¶)</span>
                                <span class="font-mono text-xs text-gray-300 truncate">{{ myId }}</span>
                            </div>
                            <span class="text-primary text-xs whitespace-nowrap ml-2">å¤åˆ¶</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500 uppercase">è”ç³»åˆ—è¡¨</span>
                            <button @click="showAddModal = true" class="text-xs text-primary font-bold">+ æ·»åŠ </button>
                        </div>

                        <div @click="enterChat('public')" :class="['p-3 rounded-xl flex items-center gap-3 cursor-pointer border transition', currentView === 'public' ? 'bg-primary/10 border-primary' : 'bg-panel border-white/5']">
                            <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center">ğŸ“¡</div>
                            <div class="flex-1">
                                <div class="font-bold text-sm text-gray-200">å¹¿æ’­é¢‘é“</div>
                                <div class="text-[10px] text-gray-500">ç¾¤å‘ç»™æ‰€æœ‰åœ¨çº¿å¥½å‹</div>
                            </div>
                        </div>

                        <div v-for="friend in friends" :key="friend.id" @click="enterChat(friend)" class="p-3 bg-panel rounded-xl border border-white/5 flex items-center justify-between active:scale-95 transition">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center text-white relative border border-white/10 font-bold">
                                    {{ friend.name.slice(0,1) }}
                                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full border-2 border-panel" :class="connections[friend.id] ? 'bg-primary' : 'bg-red-500'"></div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-bold text-sm text-gray-200 truncate">{{ friend.name }}</div>
                                    <div class="text-[10px]" :class="connections[friend.id] ? 'text-primary' : 'text-gray-500'">{{ connections[friend.id] ? 'åœ¨çº¿' : 'ç¦»çº¿' }}</div>
                                </div>
                            </div>
                            <button @click.stop="deleteFriend(friend.id)" class="px-2 text-gray-500 hover:text-red-500">âœ•</button>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button @click="clearData" class="w-full py-3 text-xs text-red-500 bg-red-500/10 rounded-lg hover:bg-red-500/20">âš  é”€æ¯æœ¬æœºæ•°æ®</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- æ·»åŠ å¥½å‹å¼¹çª— -->
        <div v-if="showAddModal" class="absolute inset-0 z-[60] bg-black/90 flex items-center justify-center p-6 backdrop-blur-sm">
            <div class="bg-panel w-full max-w-xs p-6 rounded-2xl border border-white/10 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-white">å»ºç«‹è¿æ¥</h3>
                <input v-model="newFriendId" placeholder="è¾“å…¥å¯¹æ–¹ ID" class="w-full bg-dark text-white p-3 rounded-lg border border-white/10 mb-3 outline-none focus:border-primary text-sm">
                <input v-model="newFriendName" placeholder="å¤‡æ³¨åç§°" class="w-full bg-dark text-white p-3 rounded-lg border border-white/10 mb-6 outline-none focus:border-primary text-sm">
                <div class="flex gap-3">
                    <button @click="showAddModal = false" class="flex-1 py-2.5 bg-white/5 text-gray-400 rounded-lg text-sm">å–æ¶ˆ</button>
                    <button @click="addFriend" class="flex-1 py-2.5 bg-primary text-black font-bold rounded-lg text-sm">ç¡®è®¤</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // UI çŠ¶æ€
            const isStarted = ref(false);
            const showMenu = ref(false);
            const showAddModal = ref(false);
            const currentView = ref('public'); 
            const activeFriendId = ref(null);
            const inputText = ref('');
            
            // æ•°æ®æ ¸å¿ƒ
            const myId = ref('åˆå§‹åŒ–...');
            const myName = ref(localStorage.getItem('nc_name') || 'åŒ¿å' + Math.floor(Math.random()*99));
            const friends = ref(JSON.parse(localStorage.getItem('nc_friends') || '[]'));
            const history = reactive(JSON.parse(localStorage.getItem('nc_history') || '{"public":[]}'));
            const connections = reactive({});
            const isOnline = ref(false);
            
            // è¡¨å•
            const newFriendId = ref('');
            const newFriendName = ref('');
            
            let peer = null;

            // è¿›å…¥ç³»ç»Ÿ (è§¦å‘å…¨å±)
            const enterSystem = () => {
                isStarted.value = true;
                // å°è¯•è§¦å‘å…¨å±
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => console.log("å…¨å±è¢«æ‹¦æˆªï¼Œç»§ç»­è¿è¡Œ"));
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                }
                
                // å»¶è¿Ÿåˆå§‹åŒ–ç½‘ç»œï¼Œç¡®ä¿é¡µé¢å·²ç¨³å®š
                setTimeout(initPeer, 500);
            };

            const initPeer = () => {
                let savedId = localStorage.getItem('nc_uid');
                if(!savedId) {
                    savedId = 'u' + Math.random().toString(36).substr(2, 6);
                    localStorage.setItem('nc_uid', savedId);
                }
                
                peer = new Peer(savedId, { debug: 1 });
                
                peer.on('open', (id) => {
                    myId.value = id;
                    isOnline.value = true;
                    retryConnections();
                });
                
                peer.on('connection', handleConn);
                peer.on('disconnected', () => isOnline.value = false);
            };

            const handleConn = (conn) => {
                conn.on('open', () => connections[conn.peer] = conn);
                conn.on('data', (data) => {
                    // æ¥æ”¶æ¶ˆæ¯
                    const msgObj = {
                        text: data.text,
                        senderName: data.fromName || 'å¯¹æ–¹',
                        time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                        isMe: false
                    };
                    const targetKey = data.type === 'public' ? 'public' : conn.peer;
                    saveMsg(targetKey, msgObj);
                });
                conn.on('close', () => delete connections[conn.peer]);
                connections[conn.peer] = conn;
            };

            const retryConnections = () => {
                if(!peer || peer.disconnected) return;
                friends.value.forEach(f => {
                    if(!connections[f.id] || !connections[f.id].open) {
                        const conn = peer.connect(f.id);
                        handleConn(conn);
                    }
                });
            };

            const send = () => {
                const text = inputText.value.trim();
                if(!text) return;

                const msgObj = {
                    text,
                    senderName: myName.value,
                    time: new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),
                    isMe: true
                };

                if(currentView.value === 'public') {
                    saveMsg('public', msgObj);
                    Object.values(connections).forEach(conn => {
                        if(conn.open) conn.send({ type: 'public', text, fromName: myName.value });
                    });
                } else {
                    const conn = connections[activeFriendId.value];
                    if(conn && conn.open) {
                        conn.send({ type: 'private', text, fromName: myName.value });
                        saveMsg(activeFriendId.value, msgObj);
                    } else {
                        alert("ç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•å‘é€");
                        return;
                    }
                }
                inputText.value = '';
                scrollToBottom();
            };

            const saveMsg = (key, msg) => {
                if(!history[key]) history[key] = [];
                history[key].push(msg);
                if(history[key].length > 100) history[key].shift();
                localStorage.setItem('nc_history', JSON.stringify(history));
                
                if((currentView.value === 'public' && key === 'public') || 
                   (currentView.value === 'private' && key === activeFriendId.value)) {
                    scrollToBottom();
                }
            };

            const scrollToBottom = () => {
                nextTick(() => {
                    const el = document.getElementById('chat-container');
                    if(el) el.scrollTop = el.scrollHeight;
                });
            };

            // è¾…åŠ©åŠŸèƒ½
            const enterChat = (target) => {
                if(target === 'public') {
                    currentView.value = 'public';
                    activeFriendId.value = null;
                } else {
                    currentView.value = 'private';
                    activeFriendId.value = target.id;
                }
                showMenu.value = false;
                scrollToBottom();
            };

            const switchView = (v) => {
                currentView.value = v;
                if(v === 'public') activeFriendId.value = null;
                scrollToBottom();
            };

            const addFriend = () => {
                if(!newFriendId.value) return;
                if(!friends.value.find(f => f.id === newFriendId.value)) {
                    friends.value.push({ id: newFriendId.value, name: newFriendName.value || 'å¥½å‹' });
                    localStorage.setItem('nc_friends', JSON.stringify(friends.value));
                    retryConnections();
                }
                showAddModal.value = false;
                newFriendId.value = ''; newFriendName.value = '';
            };

            const deleteFriend = (id) => {
                if(confirm("åˆ é™¤è¿æ¥ï¼Ÿ")) {
                    friends.value = friends.value.filter(f => f.id !== id);
                    localStorage.setItem('nc_friends', JSON.stringify(friends.value));
                }
            };
            
            const saveSettings = () => localStorage.setItem('nc_name', myName.value);
            const copyId = () => { navigator.clipboard.writeText(myId.value); alert("å·²å¤åˆ¶"); };
            const clearData = () => { if(confirm("é”€æ¯æ•°æ®ï¼Ÿ")) { localStorage.clear(); location.reload(); } };

            // Computed
            const title = computed(() => {
                if(currentView.value === 'public') return 'å¹¿æ’­é¢‘é“';
                const f = friends.value.find(f => f.id === activeFriendId.value);
                return f ? f.name : 'ç§èŠ';
            });
            const currentMessages = computed(() => {
                if(currentView.value === 'public') return history['public'] || [];
                return history[activeFriendId.value] || [];
            });

            return {
                isStarted, enterSystem, showMenu, showAddModal, currentView, 
                myName, myId, isOnline, friends, connections, inputText,
                newFriendId, newFriendName, title, currentMessages,
                send, enterChat, switchView, addFriend, deleteFriend, saveSettings, copyId, clearData
            };
        }
    }).mount('#app');
</script>
</body>
</html>